<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>文件上傳</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="/static/js/layui/css/layui.css" media="all">
		<!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
	</head>
	<body>
		<div>
			<fieldset class="layui-elem-field layui-field-title">
				<legend style="font-weight:bold">
					<span style="font-size: 1.5rem;">資料庫上傳</span>
				</legend>
			</fieldset>
		</div>
		<div style="margin-left: 50px">
			<form class="layui-form" action="">
				<input type="file" class="form-control" id="file-value">
				<button type="button" class="layui-btn layui-btn-radius" id="preview-btn">預覽</button>

				<div class="layui-input-inline">
					<select name="upload_table" id="select">
						<option value=""></option>
						<option value="Bom">Bom</option>
						<option value="MachineList">機台列表</option>
						<option value="MoldPnAssociation">模具料號對照表</option>
						<option value="Anomaly">異常列表</option>
					</select>
				</div>

				<button type="button" class="layui-btn layui-btn-radius" lay-submit lay-filter="formDemo" id="upload-btn">上傳</button>
			</form>
		</div>
		<hr class="layui-bg-green">

		<!--  <button type="button" class="layui-btn layui-btn-radius" id="update">確認更新</button>-->
		<div style="margin-left: 50px">
			<table id="demo" lay-filter="demo" ></table>
		</div>



		<script src="/static/js/layui/layui.all.js" charset="utf-8"></script>
		<script src="/static/js/jquery-3.3.1.min.js" charset="utf-8"></script>
		<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
		<script>
			var table = layui.table;
			var layer = layui.layer;
			var form = layui.form;
			//
			// $.ajax({
			// 	url: '',
			// 	type: "get",
			// 	dataType: 'json',
			// 	success: function(res) {
			// 		console.log('success')
			// 		$('#select').html('')
			// 	}
			// })

			//监听提交
			form.on('submit(formDemo)', function(f) {
				var form_data = f.field
				console.log(form_data)
				if (data.length) {
					layer.open({
						title: '上傳確認',
						content: '上傳資料:' + form_data['upload_table'],
						btn: ['確認上傳', '取消'],
						yes: function(index, layero) {
							if (form_data['upload_table']===''){
								layer.close(index);
								layer.msg('沒有選擇上傳表格');
							}else{
								var upload_data = {upload_table:form_data['upload_table'], data}
								console.log(upload_data)
								layer.close(index); //如果设定了yes回调，需进行手工关闭
								$.ajax({
									url: '{{url_for('revise.ajax_data_upload')}}',
									type: "POST",
									data: JSON.stringify(upload_data),
									dataType: 'json',
									success: function(res) {
										layer.msg('上傳成功')
										console.log('上傳成功')
										console.log(res)
									}
								})
							}

							//按钮【按钮一】的回调
						},
						cancel: function() {
							//右上角关闭回调
						}
					})
				} else {
					layer.msg('沒有上傳數據');
				}

				// layer.msg(JSON.stringify(data.field));
				return false;
			});

			var data = [];
			$("#preview-btn").click(function() {
				data = [];
				var files = document.getElementById("file-value").files;
				var regp = new RegExp(".*,\".*,.*\"$");
				if (files.length) {
					var file = files[0];

					var reader = new FileReader(); //new一个FileReader实例
					if (typeof FileReader == 'undefined') {
						layer.alert("你的浏览器暂不支持该功能", {
							title: "提示",
							skin: "layui-layer-molv"
						});
						file.setAttribute("disabled", "disabled");
						return;
					}
					reader.readAsText(file);
					reader.onload = function(f) {
						//					var result = document.getElementById("result");
						//显示文件
						// 相同意思f.target = this
						var relArr = this.result.split("\r\n");
						if (!$.isEmptyObject(relArr) && relArr.length > 1) {
							var cols = relArr[0].split(","); // 表頭
							var cols_en = relArr[1].split(",");

							for (var key = 2, len = relArr.length; key < len; key++) {

								var values = relArr[key];
								if (regp.test(values)) {
									alert("文件内容中有英文逗号，麻烦修改后再上传，含有英文逗号的内容是：" + values);
									return;
								}
								if (!$.isEmptyObject(values)) {
									var obj = {};
									var objArr = values.split(",");
									for (var i = 0; i < cols.length; i++) {
										obj[cols_en[i]] = objArr[i];
									}
									data.push(obj);
								}
							}
							// 創建layui表頭
							var cols_array = []
							for (var i=0; i < cols.length; i++){
								cols_array.push({field: cols_en[i], title: cols[i], minWidth:100})
							}
							cols_array = [cols_array]
							console.log(cols_array)
						}
						console.log(data);
						// layui.use('table', function() {

						// 执行渲染
						console.log('data')
						console.log(data)
						table.render({
							elem: '#demo', //指定原始表格元素选择器（推荐id选择器）
							data: data,
							width: '1000',
							height: 600, //容器高度
							page: true,
							limit: 13,
							cols: cols_array

						});
					}
				}
			})
		</script>

	</body>
</html>
