<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>成型條件紀錄查詢</title>
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel="stylesheet" href="static/js/layui/css/layui.css" media="all">
		<script src="static/js/vue.js"></script>
		<style>
			.table_div {
				height: 400px;
				width: 100%;
				/* display: block; */
			}
			.table_div::-webkit-scrollbar{
				display: none;
			}
			.y_scroll {
				overflow-y: scroll;
			}
			.x_scroll {
				overflow-x: scroll;
			}
			.head {
				display: inline-block;
				float: left;
				width: 300px;
			}
			.table_top {
				height: 150px;
			}
			.date {
				font-size: 12px;
			}
			.data_table::-webkit-scrollbar{
				display: none;
			}
			.data_table td{
				padding: 2px;
				border: 1px solid black;
				text-align: center;
			}
			table {
				/* table-layout: fixed; */
			}
			td {
				padding: 2px;
				border: 1px solid black;
				border-collapse: collapse;
				height: 21px;
			}
		</style>
	</head>
	<body>
		<fieldset class="layui-elem-field layui-field-title">
			<legend style="font-weight:bold">
				<span style="font-size: 1.5rem">成型條件紀錄查詢</span>
			</legend>
		</fieldset>
		<div class="layui-row">
			<form class="layui-form" action="" lay-filter='all'>
				<!-- <div class="layui-form-item">
					<label class="layui-form-label">日期</label>
					<div class="layui-input-inline">
						<input type="text" name="date" id="date" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
					</div>
				</div> -->
				<div class="layui-form-item">
					<label class="layui-form-label">棟別</label>
					<div class="layui-input-inline">
						<select name="building" id="building" lay-filter='select_building' lay-verify="required">
							<option value="A18">A18</option>
							<option value="A17">A17</option>
							<option value="A16">A16</option>
						</select>
					</div>
					<label class="layui-form-label">噸數</label>
					<div class="layui-input-inline">
						<select name="tonnage" id="tonnage" lay-filter='select_tonnage' lay-verify="required">
							<option value="">請選擇</option>
						</select>
					</div>
					<label class="layui-form-label">機台</label>
					<div class="layui-input-inline">
						<select name="machine" id="machine" lay-filter='select_machine' lay-verify="required">
							<option value="">請選擇</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">料號</label>
					<div class="layui-input-inline" id="part_number_div">
						<select id="part_number" name="part_number" lay-filter="select_part_number" lay-verify="required">
							<option value ="">請選擇</option>
						</select>
					</div>
					<label class="layui-form-label">模穴號</label>
					<div class="layui-input-inline" id="mold_div">
						<select id="mold" name="mold" lay-filter="select_mold" lay-verify="required">'
							<option value ="">請選擇</option>
						</select>
					</div>
					<label class="layui-form-label">日期</label>
					<div class="layui-input-inline">
						<input type="text" name="date" id="date" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
					</div>
				</div>
			</form>
		</div>

		<div id="query" v-if="show">
			<div class="layui-row" style="padding: 15px 30px;">
				<hr>
				<div style="float: right;">
					<button class="layui-btn layui-btn-primary"type="button" id="scrollleft">
						&lt; 
					</button> 
					<button class="layui-btn layui-btn-primary" type="button" id="scrollright">
						&gt;
					</button>
				</div>
			</div>
			<div class="" style="padding: 0px 30px;" v-if="show">
				<div class="table_top">
					<div class="head" style="height: inherit;">
						<table style="width: 100%; height: 100%;">
							<tr>
								<td>模號</td>
								<td>{[mold]}</td>
								<td>機型</td>
								<td>{[params.machine_type]}</td>
							</tr>
							<tr>
								<td>產品料號</td>
								<td>{[part_number]}</td>
								<td>出場編號</td>
								<td>{[params.machine_no]}</td>
							</tr>
							<tr>
								<td>原料料號</td>
								<td>{[params.material_part_number]}</td>
								<td>原料規格</td>
								<td>{[params.material_spec]}</td>
							</tr>
						</table>
					</div>
					<div class="x_scroll data_table" style="height: inherit;">
						<table style="width: 100%; height: inherit; display: inline-block; ">
							<tbody style="height: inherit;">
								<tr is="vue-table" :param="params.TIMESTAMP" class="date" style="height: inherit;"></tr>
							</tbody>
						</table>
					</div>
				</div>

				<div class="table_div y_scroll">
					<div class="head">
						<table style="width: inherit;">
							<tbody>
								<tr>
									<td rowspan="6">
										<p>加料溫度</p>
										<p>(感測器)</p>
									</td>
									<td colspan="3">噴嘴</td>
								</tr>
								<tr>
									<td colspan="3">截流閥</td>
								</tr>
								<tr>
									<td colspan="3">加熱一</td>
								</tr>
								<tr>
									<td colspan="3">加熱二</td>
								</tr>
								<tr>
									<td colspan="3">加熱三</td>
								</tr>
								<tr>
									<td colspan="3">加熱四</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td colspan="4">乾燥溫度</td>
								</tr>
								<tr>
									<td colspan="4">乾燥時間</td>
								</tr>
								<tr>
									<td colspan="4">露點</td>
								</tr>
								<tr>
									<td colspan="4">油溫</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td>公模</td>
									<td colspan="3">模溫機常溫水冷凍水</td>
								</tr>
								<tr>
									<td>母模</td>
									<td colspan="3">模溫機常溫水冷凍水</td>
								</tr>
								<tr>
									<td>滑塊</td>
									<td colspan="3">模溫機常溫水冷凍水</td>
								</tr>
								<tr>
									<td>撥料板</td>
									<td colspan="3">模溫機常溫水冷凍水</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td colspan="4">螺桿轉速</td>
								</tr>
								<tr>
									<td colspan="4">背壓</td>
								</tr>
								<tr>
									<td colspan="4">計量</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td rowspan="7">射出位置mm</td>
									<td colspan="3">射一</td>
								</tr>
								<tr>
									<td colspan="3">射二</td>
								</tr>
								<tr>
									<td colspan="3">射三</td>
								</tr>
								<tr>
									<td colspan="3">射四</td>
								</tr>
								<tr>
									<td colspan="3">射五</td>
								</tr>
								<tr>
									<td colspan="3">射六</td>
								</tr>
								<tr>
									<td colspan="3">射膠終點</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td rowspan="6">射出速度mm</td>
									<td colspan="3">V1</td>
								</tr>
								<tr>
									<td colspan="3">V2</td>
								</tr>
								<tr>
									<td colspan="3">V3</td>
								</tr>
								<tr>
									<td colspan="3">V4</td>
								</tr>
								<tr>
									<td colspan="3">V5</td>
								</tr>
								<tr>
									<td colspan="3">V6</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td rowspan="6">射壓</td>
									<td colspan="3">P1</td>
								</tr>
								<tr>
									<td colspan="3">P2</td>
								</tr>
								<tr>
									<td colspan="3">P3</td>
								</tr>
								<tr>
									<td colspan="3">P4</td>
								</tr>
								<tr>
									<td colspan="3">P5</td>
								</tr>
								<tr>
									<td colspan="3">P6</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td colspan="4">保壓切換位置mm</td>
								</tr>
								<tr>
									<td colspan="4">保壓切換時間sec</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td rowspan="4">保壓</td>
									<td colspan="3">P1</td>
								</tr>
								<tr>
									<td colspan="3">P2</td>
								</tr>
								<tr>
									<td colspan="3">P3</td>
								</tr>
								<tr>
									<td colspan="3">P4</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td colspan="4">S9</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td rowspan="7">時間</td>
									<td colspan="3">保壓1</td>
								</tr>
								<tr>
									<td colspan="3">保壓2</td>
								</tr>
								<tr>
									<td colspan="3">保壓3</td>
								</tr>
								<tr>
									<td colspan="3">保壓4</td>
								</tr>
								<tr>
									<td colspan="3">射出</td>
								</tr>
								<tr>
									<td colspan="3">冷卻</td>
								</tr>
								<tr>
									<td colspan="3">週期</td>
								</tr>
							</tbody>
							<tbody>
								<tr>
									<td rowspan="15">熱膠道溫度</td>
									<td colspan="3">T1</td>
								</tr>
								<tr>
									<td colspan="3">T2</td>
								</tr>
								<tr>
									<td colspan="3">T3</td>
								</tr>
								<tr>
									<td colspan="3">T4</td>
								</tr>
								<tr>
									<td colspan="3">T5</td>
								</tr>
								<tr>
									<td colspan="3">T6</td>
								</tr>
								<tr>
									<td colspan="3">T7</td>
								</tr>
								<tr>
									<td colspan="3">T8</td>
								</tr>
								<tr>
									<td colspan="3">T9</td>
								</tr>
								<tr>
									<td colspan="3">T10</td>
								</tr>
								<tr>
									<td colspan="3">T11</td>
								</tr>
								<tr>
									<td colspan="3">T12</td>
								</tr>
								<tr>
									<td colspan="3">T13</td>
								</tr>
								<tr>
									<td colspan="3">T14</td>
								</tr>
								<tr>
									<td colspan="3">T15</td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="x_scroll data_table">
						<table class="table" style="width: 100%; height: 100%; display: inline-block; float: left;">
							<tr is="vue-table" :param="params.NowTn2"></tr>
							<tr is="vue-table" :param="['-','-']"></tr>
							<tr is="vue-table" :param="params.NowT1"></tr>
							<tr is="vue-table" :param="params.NowT2"></tr>
							<tr is="vue-table" :param="params.NowT3"></tr>
							<tr is="vue-table" :param="params.NowT4"></tr>
							<tr is="vue-table" :param="params.DryTemp"></tr>
							<tr is="vue-table" :param="params.DryTime"></tr>
							<tr is="vue-table" :param="params.DewPoint"></tr>
							<tr is="vue-table" :param="params.OilTemp"></tr>
							<tr is="vue-table" :param="params.MoTnMale"></tr>
							<tr is="vue-table" :param="params.MoTnFemale"></tr>
							<tr is="vue-table" :param="params.MoSlider"></tr>
							<tr is="vue-table" :param="params.Plate"></tr>
							<tr is="vue-table" :param="params.ChrSpd3"></tr>
							<tr is="vue-table" :param="params.ChrPrs3"></tr>
							<tr is="vue-table" :param="params.ChrPos4"></tr>
							<tr is="vue-table" :param="params.InjPos0"></tr>
							<tr is="vue-table" :param="params.InjPos1"></tr>
							<tr is="vue-table" :param="params.InjPos2"></tr>
							<tr is="vue-table" :param="params.InjPos3"></tr>
							<tr is="vue-table" :param="params.InjPos4"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.InjSpd0"></tr>
							<tr is="vue-table" :param="params.InjSpd1"></tr>
							<tr is="vue-table" :param="params.InjSpd2"></tr>
							<tr is="vue-table" :param="params.InjSpd3"></tr>
							<tr is="vue-table" :param="params.InjSpd4"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.InjPrs0"></tr>
							<tr is="vue-table" :param="params.InjPrs1"></tr>
							<tr is="vue-table" :param="params.InjPrs2"></tr>
							<tr is="vue-table" :param="params.InjPrs3"></tr>
							<tr is="vue-table" :param="params.InjPrs4"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.InjPos4"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.HldPrs0"></tr>
							<tr is="vue-table" :param="params.HldPrs1"></tr>
							<tr is="vue-table" :param="params.HldPrs2"></tr>
							<tr is="vue-table" :param="params.HldPrs3"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.HldTime0"></tr>
							<tr is="vue-table" :param="params.HldTime1"></tr>
							<tr is="vue-table" :param="params.HldTime2"></tr>
							<tr is="vue-table" :param="params.HldTime3"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.TimeDchr"></tr>
							<tr is="vue-table" :param="['-']"></tr>
							<tr is="vue-table" :param="params.HtRunT1"></tr>
							<tr is="vue-table" :param="params.HtRunT2"></tr>
							<tr is="vue-table" :param="params.HtRunT3"></tr>
							<tr is="vue-table" :param="params.HtRunT4"></tr>
							<tr is="vue-table" :param="params.HtRunT5"></tr>
							<tr is="vue-table" :param="params.HtRunT6"></tr>
							<tr is="vue-table" :param="params.HtRunT7"></tr>
							<tr is="vue-table" :param="params.HtRunT8"></tr>
							<tr is="vue-table" :param="params.HtRunT9"></tr>
							<tr is="vue-table" :param="params.HtRunT10"></tr>
							<tr is="vue-table" :param="params.HtRunT11"></tr>
							<tr is="vue-table" :param="params.HtRunT12"></tr>
							<tr is="vue-table" :param="params.HtRunT13"></tr>
							<tr is="vue-table" :param="params.HtRunT14"></tr>
							<tr is="vue-table" :param="params.HtRunT15"></tr>
						</table>
					</div>
				</div>
			</div>
		</div>
		<script src="static/js/layui/layui.all.js" charset="utf-8"></script>
		<script src="static/js/jquery-3.3.1.min.js" charset="utf-8"></script>
		<script src="static/js/tolerance.js" charset="utf-8"></script>
		<script src="static/js/moment.js" charset="utf-8"></script>
		<script type="text/javascript">
			var form = layui.form;
			var table = layui.table;
			var laydate = layui.laydate;
			var server_post = {
				'date': moment().format('YYYY-MM-DD'),
				'building': 'A18',
				'tonnage': '450T'
			}

			laydate.render({
				elem: '#date',
				type: 'date',
				range: true,
				done: function(value, date, endDate) {
					console.log(value); //得到日期生成的值，如：2017-08-18
					console.log(date); //得到日期时间对象：{year: 2017, month: 8, date: 18, hours: 0, minutes: 0, seconds: 0}
					console.log(endDate); //得结束的日期时间对象，开启范围选择（range: true）才会返回。对象成员同上。
					server_post['time_range'] = value
					get_param()
				}
			});
			// var server_post = {'date': moment().format('YYYY-MM-DD'), 'building': 'A18', 'tonnage': '450T'}
			// 監聽棟別
			form.on('select(select_building)', function(data) {
				console.log('棟別:' + data.value); //得到被选中的值
				server_post['building'] = data.value
				vm1.show = 0
				get_schedule(data.value)
			})
			// 獲取監聽機台,排產
			var get_schedule = function(fn_data) {
				$.ajax({
					url: '{{url_for('schedule.ajax_machine_list')}}',
					type: "POST",
					data: JSON.stringify({
						'building': fn_data
					}),
					dataType: 'json',
					success: function(res) {
						console.log('獲取機台列表')
						console.log(res)

						// 監聽噸數
						var get_machine = function() {

							console.log(server_post['tonnage'])
							var html = '<option value="">請選擇</option>'
							for (var i = 0; i < res[server_post['tonnage']].length; i++) {
								var html = html + '<option value="' + res[server_post['tonnage']][i] + '">' + res[server_post['tonnage']][
									i
								] + '</option>'
								$('#machine').html(html)
							}
							form.render(null, 'all'); //更新 lay-filter="all" 所在容器内的全部表单状态
						}
						$('#tonnage').html('<option value="">' + server_post['tonnage'] + '</option>')
						get_machine()
						for (var key in res) {
							var html = '<option value="' + key + '">' + key + '</option>'
							$('#tonnage').append(html)
						}
						form.render(null, 'all'); //更新 lay-filter="all" 所在容器内的全部表单状态

						form.on('select(select_tonnage)', function(data) {
							vm1.show = 0
							console.log("噸數:" + data.value); //得到被选中的值
							server_post['tonnage'] = data.value
							get_machine()
							// $('#machine').html('<option value="">請選擇</option>')
							// for (var i = 0; i < res[data.value].length; i++) {
							// 	var html = '<option value="' + res[data.value][i] + '">' + res[data.value][i] + '</option>'
							// 	$('#machine').append(html)
							// }
							// form.render(null, 'all'); //更新 lay-filter="all" 所在容器内的全部表单状态
						})
						// 監聽機台
						form.on('select(select_machine)', function(data) {
							vm1.show = 0
							console.log("機台:" + data.value); //得到被选中的值
							server_post['machine'] = data.value
							// 讀取生產計劃取得料號/模號
							console.log(server_post)
							get_part_number()
						})
					}
				})
			}
			var get_part_number = function() {
				$(".hide").hide()
				$.ajax({
					url: '{{url_for('production.ajax_get_used_mold')}}',
					type: "POST",
					data: JSON.stringify(server_post),
					dataType: 'json',
					success: function(res) {
						console.log("排產計畫")
						console.log(res)

						if (res.error != '') {
							layer.msg(res.error)

						}

						if (typeof(res.data) == 'undefined') {
							return
						}
						if (res.data.default.length){
							server_post['machine_id'] = res.data.default[0].machine_id

							html = "<option value='" + res.data.default[0]['part_number'] + "'>" + res.data.default[0]['part_number'] + '</option>'
							$('#part_number').html(html)

							html = "<option value='" + res.data.default[0]['mold'] + "'>" + res.data.default[0]['mold'] + '</option>'
							$('#mold').html(html)

							server_post['part_number'] = res.data.default[0]['part_number']
							server_post['mold'] = res.data.default[0]['mold']
							server_post['mold_id'] = res.data.default[0]['mold_id']
							get_param()
						}else{
							$('#part_number').html('')
						}

						for (key in res.data) {
							if (key == 'default'){
								break;
							}
							html = "<option value='" + key + "'>" + key + '</option>'
							$('#part_number').append(html)
							form.render(null, 'all');
						}
						form.on('select(select_part_number)', function(data) {
							console.log("料號:", data.value); //得到被选中的值
							var part_number = data.value
							vm1.show = 0
							$('#mold').html('<option value="">請選擇</option>')
							var html = ''
							for (var i = 0; i < res.data[part_number].length; i++) {
								html = html + "<option value='" + res.data[part_number][i]['mold'] + "," + res.data[part_number][i]['mold_id'] + "'>"
								+ res.data[part_number][i]['mold'] + '</option>'
							}
							$('#mold').append(html)
							form.render(null, 'all');

							form.on('select(select_mold)', function(data) {
								vm1.show = 0
								console.log("模具:"); //得到被选中的值
								data.value = data.value.split(",")
								server_post['mold'] = data.value[0]
								server_post['part_number'] = part_number
								server_post['mold_id'] = data.value[1]
								get_param()
							})
						})
					},
				})
			}
			get_schedule(server_post['building'])


			Vue.component('vue-table', {
				template: '<tr class="tr">\
							<td v-for="data in param" >\
								<div style="width: 60px;">\
									{[(data)?data:"-"]}\
								</div>\
							</td>\
						</tr>',
				props: ['param'],
				delimiters: ['{[', ']}'],

			})
			var vm1 = new Vue({
				delimiters: ['{[', ']}'],
				el: '#query',
				data: {
					params: [],
					mold: '',
					part_number: '',
					show: 0,
				},
			})

			var get_param = function() {
				console.log(server_post)
				$.ajax({
					url: '{{url_for('production.ajax_params_record_query')}}',
					type: "POST",
					data: JSON.stringify(server_post),
					dataType: 'json',
					error: function(XMLHttpRequest, textStatus, errorThrown) {
								layer.msg(XMLHttpRequest.responseText)
					},
					success: function(res) {
						console.log(res)
						vm1.params = res
						$("#scrollright").click(function() {
							$('.data_table').scrollLeft($('.data_table').scrollLeft() + 100)
						})
						$("#scrollleft").click(function() {
							$('.data_table').scrollLeft($('.data_table').scrollLeft() - 100)
						})
						vm1.mold = server_post['mold']
						vm1.part_number = server_post['part_number']
						vm1.show = 1
					}
				})
			}
			// get_param()
		</script>
	</body>
</html>
